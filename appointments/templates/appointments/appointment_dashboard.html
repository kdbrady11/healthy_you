<!DOCTYPE html>
<html>
<head>
  <title>Appointments Dashboard</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <!-- FullCalendar CSS -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet" />
  <style>
    #calendar {
      max-width: 900px;
      margin: 20px auto;
    }
  </style>
</head>
<body>
<div class="container mt-4">
  <h2>Appointments Dashboard</h2>
  <!-- Tabs for Calendar, Create, and Old Appointments -->
  <ul class="nav nav-tabs" id="apptTab" role="tablist">
    <li class="nav-item">
      <a class="nav-link active" id="calendar-tab" data-toggle="tab" href="#calendarView" role="tab">Calendar</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="create-tab" data-toggle="tab" href="#createView" role="tab">Create Appointment</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="old-tab" data-toggle="tab" href="#oldView" role="tab">Old Appointments</a>
    </li>
      <li class="nav-item">
  <a class="nav-link" id="upcoming-tab" data-toggle="tab" href="#upcomingView" role="tab">Upcoming Appointments</a>
</li>
  </ul>
  <div class="tab-content mt-3" id="apptTabContent">
    <!-- Calendar Tab -->
    <div class="tab-pane fade show active" id="calendarView" role="tabpanel">
      <div id="calendar"></div>
    </div>
    <!-- Create Appointment Tab -->
    <div class="tab-pane fade" id="createView" role="tabpanel">
      <h3>Create Appointment</h3>
      <form method="post" action="{% url 'appointment_create' %}">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit" class="btn btn-primary">Create Appointment</button>
      </form>
    </div>
    <!-- Old Appointments Tab -->
    <div class="tab-pane fade" id="oldView" role="tabpanel">
      <h3>Old Appointments (Before Now)</h3>
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>Title</th>
            <th>Date</th>
            <th>Time</th>
            <th>Location</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for appt in old_appointments %}
          <tr>
            <td>{{ appt.title }}</td>
            <td>{{ appt.appointment_date }}</td>
            <td>{{ appt.appointment_time }}</td>
            <td>{{ appt.location }}</td>
            <td>{{ appt.get_status_display }}</td>
            <td>
              <form method="post" action="{% url 'appointment_delete' appt.id %}" onsubmit="return confirm('Are you sure you want to delete this appointment?');">
                {% csrf_token %}
                <button type="submit" class="btn btn-sm btn-danger">Delete</button>
              </form>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="6">No old appointments found.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <div class="mt-3 text-center">
        <button id="backToCalendar" class="btn btn-secondary">Back to Calendar</button>
      </div>
    </div>
    <div class="tab-pane fade" id="upcomingView" role="tabpanel">
  <h3>Upcoming Appointments</h3>
  {% if upcoming_appointments %}
    <table class="table table-bordered">
      <thead>
        <tr>
          <th>Title</th>
          <th>Date</th>
          <th>Time</th>
          <th>Location</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for appt in upcoming_appointments %}
        <tr>
          <td>{{ appt.title }}</td>
          <td>{{ appt.appointment_date }}</td>
          <td>{{ appt.appointment_time }}</td>
          <td>{{ appt.location }}</td>
          <td>{{ appt.get_status_display }}</td>
          <td>
            <a href="{% url 'appointment_detail' appt.id %}" class="btn btn-sm btn-info">View</a>
            <form method="post" action="{% url 'appointment_delete' appt.id %}" onsubmit="return confirm('Are you sure you want to delete this appointment?');" class="d-inline">
              {% csrf_token %}
              <button type="submit" class="btn btn-sm btn-danger">Delete</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p>No upcoming appointments found.</p>
  {% endif %}
</div>

  </div>
  <p class="mt-3"><a href="{% url 'dashboard' %}">Return to Main Dashboard</a></p>
</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize FullCalendar
    var calendarEl = document.getElementById('calendar');
    if (calendarEl) {
      var events = {{ events|default:"[]"|safe }}; // Make sure events is valid JSON
      var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        events: events, // Events from your Django context
        eventClick: function(info) {
          // Handle event click if needed
          return false;
        }
      });
      calendar.render();

      // Re-render the calendar when Calendar tab is shown and ensure proper size
      $('a[data-toggle="tab"]').on('shown.bs.tab', function(e) {
        var target = $(e.target).attr("href");
        if (target === "#calendarView") {
          calendar.updateSize();
        }
      });
    }

    // Activate the correct tab based on "active_tab" URL parameter
document.addEventListener('DOMContentLoaded', function () {
  var urlParams = new URLSearchParams(window.location.search);
  var activeTab = urlParams.get('active_tab');

  if (activeTab) {
    // Show the tab specified by the URL parameter
    $('#apptTab a[href="#' + activeTab + '"]').tab('show');
  } else {
    // Default to the Calendar tab if no active_tab is provided
    $('#apptTab a[href="#calendarView"]').tab('show');
  }

  // Update URL when switching tabs
  $('#apptTab a[data-toggle="tab"]').on('click', function (e) {
    var activeTab = $(e.target).attr("href").substring(1); // Get the tab ID without "#"
    var url = new URL(window.location);
    url.searchParams.set('active_tab', activeTab);
    window.history.replaceState(null, '', url); // Update the browser address without reloading
  });
});

    // Back to Calendar button
    $('#backToCalendar').on('click', function(e) {
      e.preventDefault();
      $('#apptTab a[href="#calendarView"]').tab('show');
    });
  });
</script>
</body>
</html>
