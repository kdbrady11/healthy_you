<!DOCTYPE html>
<html>
<head>
  <title>Sleep Dashboard</title>
  <!-- Include Bootstrap CSS, jQuery, Bootstrap JS, and Chart.js -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div class="container mt-4">
  <h2>Sleep Dashboard</h2>
  <!-- Navigation Tabs -->
  <ul class="nav nav-tabs" id="sleepTab" role="tablist">
    <li class="nav-item">
      <a class="nav-link active" id="sleep-data-tab" data-toggle="tab" href="#sleep-data" role="tab">Data Entry</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="sleep-viz-tab" data-toggle="tab" href="#sleep-viz" role="tab">Visualizations</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="sleep-feedback-tab" data-toggle="tab" href="#sleep-feedback" role="tab">Feedback</a>
    </li>
  </ul>
  <div class="tab-content mt-3" id="sleepTabContent">
    <!-- Data Entry Tab -->
    <div class="tab-pane fade show active" id="sleep-data" role="tabpanel">
      <h3>Enter Sleep Data</h3>
      <form method="post">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit" class="btn btn-primary">Submit</button>
      </form>
    </div>
    <!-- Visualizations Tab -->
    <div class="tab-pane fade" id="sleep-viz" role="tabpanel">
      <h3>Visualizations</h3>
      <div class="row">
        <div class="col-md-6">
          <h4>Sleep Duration Over Time (hrs)</h4>
          <canvas id="durationChart" width="400" height="300"></canvas>
        </div>
        <div class="col-md-6">
          <h4>Sleep Quality Over Time</h4>
          <canvas id="qualityChart" width="400" height="300"></canvas>
        </div>
      </div>
      <script>
        var dates = {{ agg_dates|safe }};
        var aggDuration = {{ agg_duration|safe }};
        var aggQuality = {{ agg_quality|safe }};
        var overallDuration = {{ overall_duration }};
        var overallQuality = {{ overall_quality }};
        var overallDurationLine = dates.map(() => overallDuration);
        var overallQualityLine = dates.map(() => overallQuality);

        // Duration Chart
        var ctxDuration = document.getElementById('durationChart').getContext('2d');
        new Chart(ctxDuration, {
          type: 'line',
          data: {
            labels: dates,
            datasets: [
              {
                label: 'Daily Total Duration (hrs)',
                data: aggDuration,
                borderColor: 'rgb(75, 192, 192)',
                fill: false
              },
              {
                label: 'Overall Duration Average',
                data: overallDurationLine,
                borderColor: 'rgb(0, 0, 0)',
                borderDash: [10,5],
                fill: false
              }
            ]
          },
          options: {
            scales: {
              x: {
                display: true,
                title: { display: true, text: 'Date' },
                ticks: { autoSkip: true, maxTicksLimit: 10 }
              },
              y: {
                display: true,
                title: { display: true, text: 'Hours' }
              }
            }
          }
        });

        // Quality Chart
        var ctxQuality = document.getElementById('qualityChart').getContext('2d');
        new Chart(ctxQuality, {
          type: 'line',
          data: {
            labels: dates,
            datasets: [
              {
                label: 'Daily Average Quality',
                data: aggQuality,
                borderColor: 'rgb(255, 159, 64)',
                fill: false
              },
              {
                label: 'Overall Quality Average',
                data: overallQualityLine,
                borderColor: 'rgb(0, 0, 0)',
                borderDash: [10,5],
                fill: false
              }
            ]
          },
          options: {
            scales: {
              x: {
                display: true,
                title: { display: true, text: 'Date' },
                ticks: { autoSkip: true, maxTicksLimit: 10 }
              },
              y: {
                display: true,
                title: { display: true, text: 'Quality (1-5)' },
                suggestedMin: 1,
                suggestedMax: 5
              }
            }
          }
        });
      </script>
    </div>
    <!-- Feedback Tab -->
    <div class="tab-pane fade" id="sleep-feedback" role="tabpanel">
      <h3>Sleep Feedback</h3>
      <div class="alert alert-info">
        {{ feedback|safe }}
      </div>
    </div>
  </div>
  <p class="mt-3"><a href="{% url 'dashboard' %}">Return to Main Dashboard</a></p>
</div>
</body>
</html>
